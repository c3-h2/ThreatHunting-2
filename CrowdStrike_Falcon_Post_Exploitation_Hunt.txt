event_platform="Win" ComputerName=*
(FileName="Control.exe") 
OR 
(FileName="Cscript.exe")
OR 
(FileName="Reg.exe")
OR
(FileName="sc.exe")
OR
(FileName="Wmic.exe") 
OR
(FileName="Wscript.exe")
OR
(FileName="net.exe")
OR 
(FileName="Bash.exe") 
OR 
(FileName="Csc.exe") 
OR
(FileName="Atbroker.exe")
OR 
FileName="Bitsadmin.exe" 
OR 
(FileName="Certutil.exe")
OR 
(FileName="Cmdkey.exe") 
OR 
FileName="Cmstp.exe"
OR 
FileName="Dfsvc.exe"
OR
FileName="Diskshadow.exe"
OR
(FileName="Dnscmd.exe")
OR
FileName="Esentutl.exe"
OR
FileName="Eventvwr.exe"
OR
(FileName="Expand.exe")
OR
FileName="Extexport.exe"
OR
(FileName="Extrac32.exe")
OR
(FileName="Findstr.exe")
OR
(FileName="Forfiles.exe")
OR
(FileName="Ftp.exe")
OR
FileName="Hh.exe"
OR
FileName="Ie4unit.exe"
OR
FileName="Ieexec.exe"
OR
FileName="Infdefaultinstall.exe"
OR
(FileName="Installutil.exe")
OR
(FileName="Makecab.exe")
OR
FileName="Mavinject.exe" 
OR 
FileName="Microsoft.Workflow.Compiler.exe" 
OR 
(FileName="Mmc.exe")
OR 
FileName="Msbuild.exe" 
OR 
FileName="Msconfig.exe" 
OR 
(FileName="Msdt.exe")
OR 
(FileName="Mshta.exe")
OR 
(FileName="Msiexec.exe")
OR 
FileName="Odbcconf.exe" 
OR 
FileName="Pcalua.exe" 
OR 
(FileName="Pcwrun.exe")
OR 
(FileName="Presentationhost.exe")
OR 
FileName="Print.exe"
OR 
(FileName="Regasm.exe")
OR 
(FileName="Regedit.exe")
OR 
FileName="Register-cimprovider.exe" 
OR 
FileName="Regsvcs.exe" 
OR 
(FileName="Regsvr32.exe")
OR 
FileName="Replace.exe" 
OR 
FileName="Rpcping.exe"
OR
(FileName="Rundll32.exe")
OR
FileName="Runonce.exe"
OR
FileName="Runscripthelper.exe"
OR
(FileName="Schtasks.exe")
OR
FileName="Scriptrunner.exe"
OR
FileName="SyncAppvPublishingServer.exe"
OR
(FileName="Verclsid.exe")
OR
FileName="Wab.exe"
OR
FileName="Xwizard.exe"
OR
(FileName="Appvlp.exe")
OR
(FileName="Bginfo.exe")
OR 
FileName="copy.exe" 
OR 
FileName="arp.exe" 
OR 
(FileName="dsquery.exe")
OR 
FileName="LOGONSERVER.exe" 
OR 
FileName="nltest.exe" 
OR 
(FileName="takeown.exe")
OR 
FileName="del.exe" 
OR 
(FileName="whoami.exe")
OR 
FileName="add.exe" 
OR 
FileName="qprocess.exe"
OR
(FileName="netstat.exe")
OR
((FileName="*.exe" OR FileName="*.js" OR FileName="*.zip") AND FilePath="*\\user\\AppData\\Local\\Temp\\*" AND CommandLine="*\\AppData\\Local\\Temp\\*")
| eval DetectionName="Post_Exploitation_Hunt"
| eval ProcessExplorer="https://falcon.crowdstrike.com/investigate/process-explorer"
| strcat ProcessExplorer "/" aid "/" TargetProcessId_decimal ProcessExplorerURL
| eval Process_Integrity_Level=case(IntegrityLevel_decimal="4096", "LOW (0x00001000)", IntegrityLevel_decimal="8192", "MEDIUM (0x00002000)", IntegrityLevel_decimal="8208", "MEDIUM (0x00002010)",IntegrityLevel_decimal="8448", "MEDIUM (0x00002100)",IntegrityLevel_decimal="8464", "MEDIUM (0x00002110)", IntegrityLevel_decimal="12288", "HIGH (0x00003000)", IntegrityLevel_decimal="16384", "SYSTEM (0x00004000)", IntegrityLevel_decimal="0", "UNTRUSTED (0x00000000)")
| stats values(ProcessExplorerURL) AS ProcessExplorerURL values(DetectionName) AS DetectionName values(ComputerName) AS Computers values(UserName) AS UserName values(DetectScenario) AS DetectScenario values(event_simpleName) AS event_simpleName values(IntegrityLevel_decimal) AS IntegrityLevel_decimal values(Process_Integrity_Level) AS Process_Integrity_Level values(GrandParentBaseFileName) AS GrandParentBaseFileName values(ParentBaseFileName) AS ParentBaseFileName values(FileName) AS FileName values(ImageFileName) AS ImageFileName values(ParentImageFileName) AS ParentImageFileName values(CommandLine) AS Commands values(CommandHistory) AS CommandHistory values(ScriptContent) AS ScriptContent values(CallStackModuleNames) AS CSMN dc(ComputerName) AS CompNumber by ComputerName
| eval T1216_Gpscript=if(match((Commands),"(?i)Gpscript.*\/logon|\/starup"),7,0)
| eval T1096_ADS=if(match((Commands),"(?i).*\.\w{3}:.*\.\w{3}"),7,0)
| eval T1096_reg=if(match(lower(Commands),"(?i).*reg(\ |.exe).*export.*:.*\w{3}|(?i).*reg.*add.*(\/d|cmd.exe).*|.*reg.*(UserAuthentication|fDenyTSConnections).*|.*reg.*save.*"),4,0)
| eval T1015_ATBroker=if(match((Commands),"(?i).*atbroker.*\/start"),4,0)
| eval T1218_Bginfo=if(match((Commands),"(?i).*Bginfo.*(\.bgi|popup|nolicprompt)"),7,0)
| eval T1202_bash=if(match((Commands),"(?i)bash(\ |.exe).*-c"),7,0)
| eval T1197_bitsadmin=if(match((Commands),"(?i).*bitsadmin(\ |.exe).*(SetNotifyCmdLine|addfile|create|Reset|RESUME|Complete).*"),10,0)
| eval T1140_certutil=if(match((Commands),"(?i).*certutil(\ |.exe).*(decode|encode|urlcache|http).*"),7,0)
| eval T1218_InfDefaultInstall=if(match((Commands),"(?i).*InfDefaultInstall.*(\.inf)"),7,0)
| eval T1049_netstat=if(match((Commands),"(?i).*netstat(\ |.exe).*"),1,0)
| eval T1049_nslookup=if(match((Commands),"(?i).*nslookup(\ |.exe).*"),1,0)
| eval T1218_PresentationHost=if(match((Commands),"(?i).*Presentationhost.*(\\.*\.\w{3})"),7,0)
| eval T1003_RpcPing=if(match((Commands),"(?i)RpcPing.*(privacy|NTLM).*"),7,0)
| eval T1220_WMIC=if(match((Commands),"(?i).*wmic(\ |.exe).*(node|create).*"),4,0)
| eval T1078_cmdkey=if(match((Commands),"(?i).*cmdkey(\ |.exe).*"),10,0)
| eval T1191_cmstp=if(match((Commands),"(?i).*cmstp(\ |.exe).*(\.\w{3})"),7,0)
| eval T1196_control=if(match((Commands),"(?i)^control(\ |.exe).*(\.\w{3})"),7,0)
| eval T1127_csc=if(match((Commands),"(?i).*csc(\ |.exe).*\.cs"),7,0)
| eval T1096_cscript=if(match((Commands),"(?i).*cscript(\ |.exe).*\.\w{3}:.*\.\w{3}"),7,0)
| eval T1096_esentutl=if(match((Commands),"(?i).*esentutl(\ |.exe).*(\/y|\/d|\/o|:).*"),7,0)
| eval T1096_expand=if(match((Commands),"(?i).*expand(\ |.exe).*(\.\w{3}|:).*"),7,0)
| eval T1096_extrac32=if(match((Commands),"(?i).*extrac32(\ |.exe).*(\.\w{3}|:|\/Y|\/C).*"),7,0)
| eval T1202_forfiles=if(match((Commands),"(?i).*forfiles(\ |.exe).*(\.\w{3}|:|\/p|\/m|\/c).*"),1,0)
| eval T1223_htmlhelp=if(match((Commands),"(?i).*HH(\ |.exe)\ .*(http|:|\.\w{3}).*"),7,0)
| eval T1218_mmc=if(match((Commands),"(?i).*mmc(\ |.exe).*"),7,0)
| eval T1096_makecab=if(match((Commands),"(?i).*makecab(\ |.exe).*(\.\w{3}|:|\\\\)"),7,0)
| eval T1218_msconfig=if(match((Commands),"(?i).*msconfig(\ |.exe).*"),7,0)
| eval T1218_msdt=if(match((Commands),"(?i).*msdt.*\\PCWDiagnostic.xml.*\\.*\.xml"),7,0) 
| eval T1170_mshta=if(match((Commands),"(?i).*mshta(\ |.exe).*\.hta|.*mshta.*vbscript.*|.*mshta.*javascript.*|.*mshta.*\w{1}:\\.*\w{3}:.*\w{3}"),7,0) 
| eval T1218_msiexec=if(match((Commands),"(?i).*msiexec(\ |.exe).*\/quiet.*\/i.*\.msi|(?i).*msiexec.*\/q.*\/i.*\.\w{3}|(?i).*msiexec.*\/[y|z].*\.\w{3}"),4,0) 
| eval T1218_odbcconf=if(match((Commands),"(?i).*odbcconf(\ |.exe).*-f.*\.rsp"),7,0)
| eval T1218_pcalua=if(match((Commands),"(?i).*pcalua.*-a.*\.exe|(?i).*pcalua.*-a.*\.dll|(?i).*pcalua.*-a.*\.cpl"),7,0)
| eval T1218_pcwrun=if(match((Commands),"(?i).*Pcwrun(\ |.exe).*(\.\w{3}).*"),7,0)
| eval T1096_print=if(match((Commands),"(?i).*print(\ |.exe).*\/D:\w{1}:.*\w{1}:\\.*\w\.\w{3}|.*print.*\/D:.*.*\\\\.*\\.*\.\w{3}"),7,0)
| eval T1096_regedit=if(match((Commands),"(?i).*regedit(\ |.exe).*\.reg"),7,0)
| eval T1117_regsvr32=if(match((Commands),"(?i).*regsvr32(\ |.exe).*scrobj.dll"),7,0)
| eval T1105_replace=if(match((Commands),"(?i).*replace(\ |.exe).*\w{1}:\\.*"),7,0)
| eval T1218_runonce=if(match((Commands),"(?i).*Runonce(\ |.exe).*\/AlternateShellStartup"),7,0)
| eval T1096_sc=if(match((Commands),"(?i).*sc\ .*create(\ |.exe).*start=.*auto|.*sc\ .*start.*"),7,0)
| eval T1053_schtasks=if(match((Commands),"(?i).*schtasks(\ |.exe).*delete.*\/TN|(?i).*schtasks.*\/(create|sc|tn).*"),7,0)
| eval T1218_verclsid=if(match((Commands),"(?i).*verclsid(\ |.exe).*\/S.*\C"),7,0)
| eval T1096_wscript=if(match((Commands),"(?i).*wscript(\ |.exe).*\.\w{3}:.*.\.\w{3}|(?i).*wscript\ .*http.*"),7,0)
| eval T1218_xwizard=if(match((Commands),"(?i).*xwizard(\ |.exe).*RunWizard.*\{.*\}"),7,0)
| eval T1096_rundll32=if(match((Commands),"(?i).*rundll32(\ |.exe).*\.\w{3}:.*.\.\w{3}.*DllMain"),7,0)
| eval T1085_rundll32=if(match((Commands),"(?i).*rundll32(\ |.exe).*\,(Advpack.dll|Ieadvpack.dll|Ieaframe.dll|Mshtml.dll|Pcwutl.dll|Setupapi.dll|Shdocvw.dll|Shell32.dll|Syssetup.dll|Url.dll|Zipfldr.dll)|(?i).*rundll32.*javascript.*RunHTMLApplication.*|(?i).*rundll32.*\-sta.*|(?i).*rundll32.*\/sta.*"),7,0)
| eval T1218_AppVLP=if(match((Commands),"(?i).*AppVLP(\ |.exe).*\.\w{3}|(?i).*AppVLP.*powershell.*\-ComObject.*"),7,0)
| eval T1218_Register_cimprovider=if(match((Commands),"(?i).*Register-cimprovider.*\-path.*(\.*\w{3})"),7,0)
| eval T1218_Scriptrunner=if(match((Commands),"(?i).*ScriptRunner.*(appvscript).*"),7,0)
| eval T1218_SyncAppvPublishingServer=if(match((Commands),"(?i).*SyncAppvPublishingServer.*"),7,0)
| eval T1035_dnscmd=if(match((Commands),"(?i).*dnscmd(\ |.exe).*(cofing|dll).*"),7,0)
| eval T1218_msxsl=if(match((Commands),"(?i).*msxsl.*\.\w{3}.*"),7,0)
| eval T1121_regasm=if(match((Commands),"(?i).*regasm(\ |.exe).*\.dll.*"),7,0)
| eval T1121_regsvcs=if(match((Commands),"(?i).*regsvcs(\ |\.exe)\.*\.dll.*"),7,0)
| eval T1218_runscripthelper=if(match((Commands),"(?i).*runscripthelper.*surfacecheck.*"),7,0)
| eval T1136_net=if(match((Commands),"(?i).*net(\ |.exe).*(user|localgroup).*\/add"),7,0)
| eval T1087_net=if(match((Commands),"(?i).*net(\ |.exe).*(\ user|\ group|\ localgroup)"),1,0)
| eval T1016_net_cfg=if(match((Commands),"(?i).*net(\ |.exe).*(config|workstation|server)"),4,0)
| eval T1135_net=if(match((Commands),"(?i).*net(\ |.exe).*(session|share|use|view)"),7,0)
| eval T1053_net_start_sch=if(match((Commands),"(?i).*net(\ |.exe).*(start\ schedule)"),10,0)
| eval T1015_copy=if(match((Commands),"(?i).*copy(\ |.exe).*\.\w{3}.*"),7,0)
| eval T1016_arp=if(match((Commands),"(?i).*arp(\ |.exe).*\-a"),1,0)
| eval T1016_routeprint=if(match((Commands),"(?i).*route(\ |.exe).*print"),1,0)
| eval T1087_dsquery=if(match((Commands),"(?i).*dsquery(\ |.exe).*(group|user|filter).*"),4,0)
| eval T1018_dc_logonserver=if(match((Commands),"(?i).*LOGONSERVER.*"),1,0)
| eval T1137_nltest=if(match((Commands),"(?i).*nltest(\ |.exe).*"),4,0)
| eval T1222_takeown=if(match((Commands),"(?i).*takeown(\ |.exe).*(\.\w{3})"),4,0)
| eval T1107_del=if(match((Commands),"(?i).*del(\ |.exe).*(\.\w{3})"),7,0)
| eval T1033_whoami=if(match((Commands),"(?i).*whoami(\ |.exe).*"),1,0)
| eval T1012_reg_query=if(match((Commands),"(?i).*reg(\ |.exe).*(profilelist).*"),4,0)
| eval T1082_ver=if(match((Commands),"(?i).*\/c\ ver"),7,0)
| eval T1060_runkey=if(match((Commands),"(?i).*add.*(\\\CurrentVersion\\\Run).*"),7,0)
| eval T1057_qprocess=if(match((Commands),"(?i).*qprocess.*"),7,0)
| eval T1038_rundll32=if(match((Commands),"(?i).*rundll32(\ |.exe).*(url\.dll|ieframe\.dll|shdocvw\.dll|OpenURL).*"),7,0)
| eval T1086_PwrShell2=if(match((Commands),"(?i).*powershell(\ |.exe).*|(?i).*powershell.*\.replace.*"),7,0)
| eval Unk = if(ScriptContentSource_decimal=0,1,0)
| eval APIs = if(match(lower(ScriptContent),"virtualalloc") OR match(lower(ScriptContent),"createthread"),3,0)
| eval Exec=if(match(lower(ScriptContent),"invoke[-\(][^wnr][^me][^io]") OR match(lower(ScriptContent), "[^r][^e]start-(service|process)") OR match(lower(ScriptContent),"shellexecute") OR match(lower(ScriptContent),"invokecommand"),1,0) 
| eval IEX=if(match(lower(ScriptContent), "(icm|iex)[ \(|]"),2,0)
| eval Dwnld=if(match(lower(ScriptContent),"Msxml2\.XMLHTTP") OR match(lower(ScriptContent),"web(client|request)") OR match(lower(ScriptContent),"sockets") OR match(lower(ScriptContent),"download(file|string)") OR match(lower(ScriptContent),"bitstransfer"),1,0)
| eval Upld=if(match(lower(ScriptContent),"uploadfile"),1,0)
| eval Encode=if(match(lower(ScriptContent),"frombase64string"),1,0)
| eval VM=if(match(lower(ScriptContent),"vbox") OR match(lower(ScriptContent),"prl_") OR match(lower(ScriptContent),"vmtool") OR match(lower(ScriptContent),"vmu*srvc"),2,0)
| eval Logs=if(match(lower(ScriptContent),"Clear\-Eventlog"),2,0)
| eval obf1=if(match(lower(ScriptContent),"bxor") OR match(lower(ScriptContent),"Get\-Alias"),4,0)
| eval NewCommand = ScriptContent
| rex field=NewCommand mode=sed "s/`[^c-eg-mo-qsuw-zA-Z]//g" 
| eval numChars = mvcount(split(NewCommand,"[char]"))-1
| eval numTicks = mvcount(split(NewCommand,"`"))-1
| eval obf2=if(numChars > 5 OR numTicks>5,2,0)
| eval obf2=if(numChars > 15 OR numTicks>15,5,0)
| eval T1086_PwrShell = 'Unk'+'APIs'+'Exec'+'IEX'+'Dwnld'+'Upld'+'Encode'+'VM'+'Logs'+'obf1'+'obf2'
| eval Initial_Access= 'T1078_cmdkey'
| eval Execution= 'T1218_PresentationHost'+'T1218_msiexec'+'T1218_odbcconf'+'T1218_pcalua'+'T1053_schtasks'+'T1218_verclsid'+'T1085_rundll32'+'T1035_dnscmd'+'T1053_net_start_sch'+'T1086_PwrShell'+'T1086_PwrShell2'
| eval Persistence= 'T1197_bitsadmin'+'T1136_net'+'T1015_copy'+'T1222_takeown'+'T1107_del'
| eval Privilege_Escalation= 'T1015_ATBroker'
| eval Defense_Evasion= 'T1096_reg'+'T1202_bash'+'T1140_certutil'+'T1218_InfDefaultInstall'+'T1220_WMIC'+'T1191_cmstp'+'T1196_control'+'T1096_cscript'+'T1127_csc'+'T1096_esentutl'+'T1096_expand'+'T1096_extrac32'+'T1202_forfiles'+'T1223_htmlhelp'+'T1218_mmc'+'T1218_msconfig'+'T1218_msdt'+'T1170_mshta'+'T1218_pcwrun'+'T1096_regedit'+'T1117_regsvr32'+'T1218_runonce'+'T1096_sc'+'T1096_wscript'+'T1218_xwizard'+'T1096_rundll32'+'T1218_AppVLP'+'T1218_Register_cimprovider'+'T1218_Scriptrunner'+'T1218_SyncAppvPublishingServer'+'T1218_msxsl'+'T1121_regasm'+'T1121_regsvcs'+'T1218_runscripthelper'+'T1096_ADS'
| eval Credential_Access= 'T1003_RpcPing'
| eval Discovery= 'T1087_net'+'T1049_netstat'+'T1018_dc_logonserver'+'T1016_arp'+'T1016_routeprint'+'T1087_dsquery'+'T1016_net_cfg'+'T1137_nltest'+'T1033_whoami'+'T1012_reg_query'
| eval Lateral_Movement= 'T1216_Gpscript'+'T1096_makecab'+'T1096_print'+'T1038_rundll32'
| eval Collection= 'T1105_replace'
| eval Exfiltration=0
| eval C2= 'T1096_makecab'
| eval AWL_bypass= 'T1218_Bginfo'
| addtotals fieldname=Score Initial_Access Execution Persistence Privilege_Escalation Defense_Evasion Credential_Access Discovery Lateral_Movement Collection Exfiltration C2 AWL_bypass
| table DetectionName ProcessExplorerURL1 Computers UserName DetectScenario event_simpleName IntegrityLevel_decimal Process_Integrity_Level Score Initial_Access Execution Persistence Privilege_Escalation Defense_Evasion Credential_Access Discovery Lateral_Movement Collection Exfiltration C2 AWL_bypass GrandParentBaseFileName ParentBaseFileName FileName ImageFileName ParentImageFileName Commands CommandHistory ScriptContent T1216_Gpscript T1096_ADS T1096_reg T1015_ATBroker T1218_Bginfo T1202_bash T1197_bitsadmin  T1140_certutil T1218_InfDefaultInstall T1218_PresentationHost T1003_RpcPing T1220_WMIC T1078_cmdkey T1191_cmstp T1196_control T1127_csc T1096_cscript T1096_esentutl T1096_expand T1096_extrac32 T1202_forfiles T1223_htmlhelp T1096_makecab T1218_mmc T1218_msconfig T1218_msdt T1170_mshta T1218_msiexec T1218_odbcconf T1218_pcalua T1218_pcwrun T1096_print T1096_regedit T1117_regsvr32 T1105_replace T1218_runonce T1096_sc T1053_schtasks T1218_verclsid T1096_wscript T1218_xwizard T1096_rundll32 T1085_rundll32 T1218_AppVLP T1218_Register_cimprovider T1218_Scriptrunner T1218_SyncAppvPublishingServer T1035_dnscmd T1218_msxsl T1121_regasm T1121_regsvcs  T1218_runscripthelper T1049_netstat T1136_net T1087_net T1016_net_cfg T1053_net_start_sch T1015_copy T1016_arp T1016_routeprint T1087_dsquery T1018_dc_logonserver T1137_nltest T1222_takeown T1107_del T1033_whoami T1012_reg_query T1082_ver T1060_runkey T1057_qprocess T1038_rundll32 T1086_PwrShell2 T1086_PwrShell CSMN
| sort Score desc
| where Score > 0
